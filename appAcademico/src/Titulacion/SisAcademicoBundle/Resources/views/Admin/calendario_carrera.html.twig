{% extends 'TitulacionSisAcademicoBundle:Home:index.html.twig'%}
{% block home %}
    <link type="text/css" rel="stylesheet" href="{{ asset('css/styles/animate.css') }}">
    <link type="text/css" rel="stylesheet" href="{{ asset('css/styles/all.css') }}">
    <link type="text/css" rel="stylesheet" href="{{ asset('css/flavr/flavr.css') }}">
    <!-- daterange picker -->
    <link type="text/css" rel="stylesheet" href="{{ asset('theme/plugins/daterangepicker/daterangepicker-bs3.css') }}">  
    <link type="text/css" rel="stylesheet" href="{{ asset('theme/plugins/colorpicker/bootstrap-colorpicker.min.css') }}">  
    <link type="text/css" rel="stylesheet" href="{{ asset('theme/plugins/timepicker/bootstrap-timepicker.min.css') }}">  
    <link type="text/css" rel="stylesheet" href="{{ asset('theme/plugins/select2/select2.min.css') }}">  
<style>
  #trash{
    width:32px;
    height:50px;
    float:left;
    padding-bottom: 15px;
    position: relative;
    margin-top: 37px;
  }
</style>
<style>
#div1 {width:350px;height:70px;padding:10px;border:1px solid #aaaaaa;}
</style>

<script src="{{ asset('js/calendarioeventos.js') }}"></script>
<section class="content">
          <div class="row">
            <div class="col-md-3">
              <div class="box box-solid">
                <div class="box-header with-border">
                  <h4 class="box-title">Eventos Académicos</h4>
                </div>
                <div class="box-body">
                  <!-- the events -->

                  <div id="external-events">

                      {%for event in data.registro %}
                          {% set color = event.nombre|split("|") %}
                           {#{dump(color)}#}
                          {% if color|length == 1%}
                                {% set colorevent = 'rgb(0, 166, 90)' %}
                          {% else %}
                                {% set colorevent = color[1] %}
                          {% endif %}
                            <div ondblclick="inactivar_evento(this)" id="{{color[0]}}" name="{{event.id_parametro}}"  class="external-event" style="background-color: {{colorevent}}">{{color[0]}}</div>
                      {% endfor %}
                      <!-- </div> -->
                    <!-- <div class="external-event bg-green">Lunch</div> event.css({"background-color": currColor, "border-color": currColor, "color": "#fff"}).addClass("external-event");
                    <div class="external-event bg-yellow">Go home</div>
                    <div class="external-event bg-aqua">Do homework</div>
                    <div class="external-event bg-light-blue">Work on UI design</div>
                    <div class="external-event bg-red">Sleep tight</div> -->
                    <p>
                      <!-- <div id="div1" ondrop="drop(event)" ondragover="allowDrop(event)"></div> -->
                      <!-- <b>Remover evento</b><img src="{{ asset('images/trashcan.png') }}" id="trash" alt=""> -->
                    </p>
                    <div class="checkbox" style="display:none;">
                      <label for="drop-remove">
                        <input type="checkbox" id="drop-remove" checked="true">
                        Remover evento
                      </label>
                    </div>
                  </div>


                </div><!-- /.box-body -->
              </div><!-- /. box -->
              <div class="box box-solid">
                <div class="box-header with-border">
                  <h3 class="box-title">Create Event</h3>
                </div>
                <div class="box-body">
                  <div class="btn-group" style="width: 100%; margin-bottom: 10px;">
                    <!--<button type="button" id="color-chooser-btn" class="btn btn-info btn-block dropdown-toggle" data-toggle="dropdown">Color <span class="caret"></span></button>-->
                    <ul class="fc-color-picker" id="color-chooser">
                      <li><a class="text-aqua" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-blue" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-light-blue" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-teal" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-yellow" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-orange" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-green" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-lime" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-red" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-purple" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-fuchsia" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-muted" href="#"><i class="fa fa-square"></i></a></li>
                      <li><a class="text-navy" href="#"><i class="fa fa-square"></i></a></li>
                    </ul>
                  </div><!-- /btn-group -->
                  <div class="input-group">
                    <input id="new-event" type="text" class="form-control" placeholder="Event Title">
                    <div class="input-group-btn">
                      <button id="add-new-event" type="button" class="btn btn-primary btn-flat">Add</button>
                    </div><!-- /btn-group -->
                  </div><!-- /input-group -->
                </div>
              </div>
            </div><!-- /.col -->
            <div class="col-md-9">
              <div class="box box-primary">
                <div class="box-body no-padding">
                  <!-- THE CALENDAR -->
                  <div id="calendar"></div>
                </div><!-- /.box-body -->
              </div><!-- /. box -->
            </div><!-- /.col -->
          </div><!-- /.row -->
        </section><!-- /.content -->

    <script src="{{ asset('js/flavr/flavr.js') }}"></script>
    <script src="{{ asset('js/flavr/flavr.min.js') }}"></script>




    <script type="text/javascript">
      jQuery(document).ready(function() {

          
          $('#reservationtime').daterangepicker({timePicker: true, timePickerIncrement: 30, format: 'MM/DD/YYYY h:mm A'});
          function drop(ev) {
              ev.preventDefault();
              var data = ev.dataTransfer.getData("text");
              ev.target.appendChild(document.getElementById(data));
              alert("hola mundo");
          }

          function allowDrop(ev) {
              alert('inserte');
              ev.preventDefault();
          }

          // function drag(ev) {
          //     ev.dataTransfer.setData("text", ev.target.id);
          // }
        // function ini_events(ele,url) {
       //          ele.each(function (url) {
       //            // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
       //            // it doesn't need to have a start or end
       //            var eventObject = {
       //              title: $.trim($(this).text()), // use the element's text as the event title
       //              url: url
       //            };

       //            // store the Event Object in the DOM element so we can get to it later
       //            $(this).data('eventObject', eventObject);

       //            // make the event draggable using jQuery UI
       //            $(this).draggable({
       //              zIndex: 1070,
       //              revert: true, // will cause the event to go back to its
       //              revertDuration: 0  //  original position after the drag
       //            });

       //          });
       //        }

       //        ini_events($('#external-events div.external-event'));
       //
           
          /* initialize the external events
          -----------------------------------------------------------------*/

          $('#external-events div.external-event').each(function() {

            // store data so the calendar knows to render an event upon drop
            // $(this).data('event', {
            //   title: $.trim($(this).text()), // use the element's text as the event title
            //   stick: true // maintain when user navigates (see docs on the renderEvent method)
            // });

            // make the event draggable using jQuery UI
            $(this).draggable({
              zIndex: 999,
              revert: true,      // will cause the event to go back to its
              revertDuration: 0  //  original position after the drag
            });

          });

        $('#calendar').fullCalendar({
          utc: true,
          header: {
                  left: 'prev,next today',
                  center: 'title',
                  right: 'month,agendaWeek,agendaDay'
          },
          buttonText: {
                  today: 'today',
                  month: 'month',
                  week: 'week',
                  day: 'day'
          },
          editable: true,
          droppable: true,
          slotDuration: '00:30:00',
           events: function (start, end, timezone, callback) {

                  $.ajax({
                    url: '{{path('admin_academico_cargar_eventos')}}',
                    type: 'POST',
                    dataType: 'json',
                    data: {param1: 'value1'},
                  })
                  .done(function(data) {
                  var events = [];
                    console.debug(data.length);
                    for(i=0;i<data.length;i++){
                      // alert(data[i]['fecha_hasta']);
                      var nombre = data[i]['nombre_evento'];
                      var arnombre = nombre.split("|");

                      // this.id = data[i]['id_sa_eventos_calendario_academico'];
                      // this.start = data[i]['fecha_desde'];
                      // this.title = arnombre[0];
                      // this.end = data[i]['fecha_hasta'];
                      // this.color = arnombre[1];
                      // events.push(this);

                      events.push({
                        id:  data[i]['id_sa_eventos_calendario_academico'],
                        idc: data[i]['id_sa_calendario_academico'],
                        title: arnombre[0],
                        start: data[i]['fecha_desde'],//new Date('2015-10-12'),
                        end:  data[i]['fecha_hasta'],//new Date('2015-10-13')
                        color: arnombre[1]
                      });
                    }

                      // $('#calendar').fullCalendar('addEventSource',events);
                    callback(events);

                  })
                  .fail(function() {
                    console.log("error");
                  })
                  .always(function() {
                    console.log("complete");
                  });
          },
          eventClick: function (calEvent, jsEvent, view){
              var html =                '   <div class="form-row">' +
                '       <input id="titulo" type="text" name="titulo" ' +
                '       placeholder="Título" />' +
                '   </div>' +
                '   <div class="form-row">' +
                '       <select id="estado" name="estado" >' +
                '       <option>Activo</option>' +
                '       <option>Inactivo</option>' +
                '       </select>' +
                '   </div>' +
                '   <div class="form-group">' +
                '       <label>Date and time range:</label>' +
                '       <div class="input-group">' +
                '       <div class="input-group-addon">' +
                '       <i class="fa fa-clock-o"></i>' +
                '   </div>' +
                '   <input type="text" class="form-control pull-right" id="reservationtime">' +
                '   </div>' +
                '   </div>' +
                '   <div class="form-row">' +
                '   </div>';


                var select = $(this).parent().siblings('.demo-select');
                var entrance = select.find('.animate-entrance :selected').text();
                var closing = select.find('.animate-closing :selected').text();

                new $.flavr({
                    title       : 'Editar Evento',
                    position :  'top-mid',
                    content     : '',
                    dialog      : 'form',
                    form        : { content: html, method: 'post' },
                    onSubmit    : function( $container, $form ){

                        var title = $('#titulo').val();
                        var fechas = $('#reservationtime').val();
                        var fech  = fechas.split("-");
                        var fec_desde = fech[0];
                        var fec_hasta = fech[1];
                        var id_evento = calEvent.id;
                        var id_calendario = calEvent.idc;
                        var estado = $("#estado").val();

                        if (estado == 'Inactivo') {
                            estado = 'I';
                        }else{
                          estado = 'A';
                        }

                        modificar_eventos_calendario(fec_desde,fec_hasta,id_evento,id_calendario,estado);
                        return false;
                    }
                });
          $('#reservationtime').daterangepicker({timePicker: true, timePickerIncrement: 30, format: 'MM/DD/YYYY h:mm A'});
          $("#titulo").val(calEvent.title);
          // $("#reservationtime").val(calEvent.start +'-'+calEvent.end);
          },
          drop: function(date, allDay){
              var start = date.format("YYYY-MM-DD 00:00:00");
              var end = date.format("YYYY-MM-DD 23:59:00");
              var id_evento = $(this).attr("name");
              // alert(id_evento);
              insertar_eventos(start,id_evento,end);

                // $('#calendar').fullCalendar('updateEvent',this);

          },
         eventDrop: function(event, delta, revertFunc) {
          console.debug("delta//"+delta);
          console.debug("event//"+event.end);

          var id_evento = event.id;
          var id_calendario = event.idc;
        // var end = event.end.format();
        var start = event.start.format("YYYY-MM-DD 00:00:00");
        var end = event.start.format("YYYY-MM-DD 23:59:00");
        // alert(end);
          modificar_eventos_calendario(start,end,id_evento,id_calendario,"A");

          }
        });
       /* ADDING EVENTS */
              var currColor = "#3c8dbc"; //Red by default
              //Color chooser button
              var colorChooser = $("#color-chooser-btn");
              $("#color-chooser > li > a").click(function (e) {
                e.preventDefault();
                //Save color
                currColor = $(this).css("color");

                //Add color effect to button
                $('#add-new-event').css({"background-color": currColor, "border-color": currColor});
              });

              $("#add-new-event").click(function (e) {
                e.preventDefault();
                //Get value and make sure it is not null

                var val = $("#new-event").val();
                if (val.length == 0) {
                  return;
                }

                //Create events
                var event = $("<div />");
                event.css({"background-color": currColor, "border-color": currColor, "color": "#fff"}).addClass("external-event ui-draggable");
                event.html(val);

                var evento_color = val+"|"+currColor;

                $('#external-events').prepend(event);

            crear_evento(evento_color);


                //Add draggable funtionality
                // ini_events(event,'www.google.com');

                //Remove event from text input
                $("#new-event").val("");
              });
      });

    </script>
    <script type="text/javascript">
        function insertar_eventos(date,id_evento,end){
          // alert(date);
            
            $.post('{{path('admin_academico_insertar_eventos')}}', {start: date, end: end, id_evento: id_evento}, function(data) {
              if(data == 1){
                mensaje_cisc( "notice", "EVENTO INSERTADO CON ÉXITO");
                $('#calendar').fullCalendar( 'refetchEvents' );
              }else{
                  mensaje_cisc( "error", "En estos momentos tenemos problemas con los servidores, lamentamos los inconvenientes");
              }
            });
        }

        function crear_evento(evento_color){
          $.post('{{path('admin_academico_crear_eventos')}}', {evento: evento_color}, function(data) {
            if(data == 1){
                mensaje_cisc( "notice", "EVENTO INSERTADO CON ÉXITO");
                // $("#external-events").load();
                location.href = '{{path('admin_academico_home')}}';
                $('#calendar').fullCalendar( 'refetchEvents' );
            }else{
                mensaje_cisc( "error", "En estos momentos tenemos problemas con los servidores, lamentamos los inconvenientes");
            }
          });
        }

        function inactivar_evento(evet){
                $(evet).attr("name");
                // alert($(evet).attr("id"));
                // $("#titulo").val($(evet).attr("id"));
            var html =                '   <div class="form-row">' +
                '       <input id="titulo" type="text" name="titulo" ' +
                '       placeholder="Título" />' +
                '   </div>' +
                '   <div class="form-row">' +
                '       <select id="estado" name="estado" >' +
                '       <option>Activo</option>' +
                '       <option>Inactivo</option>' +
                '       </select>' +
                '   </div>' +
                '   <div class="form-row">' +
                '   </div>';

                var select = $(this).parent().siblings('.demo-select');
                var entrance = select.find('.animate-entrance :selected').text();
                var closing = select.find('.animate-closing :selected').text();

                new $.flavr({
                    title       : 'Editar Evento',
                    content     : '',
                    dialog      : 'form',
                    form        : { content: html, method: 'post' },
                    onSubmit    : function( $container, $form ){
                        $.post('{{path('admin_academico_editar_eventos')}}', {evento: $("#titulo").val(), id_evento: $(evet).attr("name"), est_evento: $("#estado").val()}, function(data) {
                          if(data == 1){
                              mensaje_cisc( "notice", "PROCESO EXITOSO!!");
                              location.href = '{{path('admin_academico_home')}}';
                              $('#calendar').fullCalendar( 'refetchEvents' );
                            }else{
                                mensaje_cisc( "error", "En estos momentos tenemos problemas con los servidores, lamentamos los inconvenientes");
                            }
                        });
                        return false;
                    }
                });
            $("#titulo").val($(evet).attr("id"));
        }//end function

        function modificar_eventos_calendario(date,end,id_evento,id_calendario,estado){
            // date = new Date(date);

            $.post('{{path('admin_academico_modificar_eventos')}}', {start: date, end: end, id_evento: id_evento,id_calendario:id_calendario,estado:estado}, function(data) {
              if(data == 1){
                mensaje_cisc( "notice", "EVENTO ACTUALIZADO CON ÉXITO");
                $('#calendar').fullCalendar( 'refetchEvents' );
              }else{
                  mensaje_cisc( "error", "En estos momentos tenemos problemas con los servidores, lamentamos los inconvenientes");
              }
            });
        }

    </script>

{% endblock %}